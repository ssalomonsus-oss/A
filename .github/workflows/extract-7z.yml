name: Flatten ModTemplate into repo root

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  flatten:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find ModTemplate and move its contents to repo root
        run: |
          set -euo pipefail

          # find first ModTemplate (ignore .git)
          MODDIR=$(find . -type d -name 'ModTemplate' -not -path './.git/*' -print -quit || true)

          if [ -z "$MODDIR" ]; then
            echo "No ModTemplate folder found. Exiting."
            exit 0
          fi

          echo "Found ModTemplate at: $MODDIR"

          # safety: don't try to move if it's the repo root
          if [ "$MODDIR" = "." ] || [ "$MODDIR" = "./" ]; then
            echo "ModTemplate is repo root â€” nothing to move."
            exit 0
          fi

          # enable moving dotfiles
          # move everything (non-dot and dotfiles). suppress errors if pattern empty.
          shopt -s dotglob || true
          mv "$MODDIR"/* . 2>/dev/null || true
          mv "$MODDIR"/.[!.]* . 2>/dev/null || true

          # remove the now-empty ModTemplate folder
          rm -rf "$MODDIR"

          echo "Contents moved to repo root and $MODDIR removed."

      - name: Commit & push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Flatten ModTemplate: move its contents into repo root and remove folder" || echo "No changes to commit"
          git push
