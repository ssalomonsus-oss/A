name: Full: extract .7z, flatten ModTemplate, ensure Dobby, build

on:
  workflow_dispatch:
    inputs:
      sevenzip_path:
        description: 'Optional path to specific .7z file in the repo (relative). Leave empty to auto-find the first .7z'
        required: false
      dobby_repo_url:
        description: 'Optional: git URL to clone Dobby into app/src/main/cpp/extern/Dobby if missing'
        required: false
      remove_archive:
        description: 'If "true", delete the .7z after extraction'
        required: false
        default: 'true'
      avoid_overwrite:
        description: 'If "true", will NOT overwrite files when moving (mv -n). Default false.'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  full:
    runs-on: ubuntu-latest

    steps:
      - name: Exit if triggered by bot push (prevents loops)
        if: ${{ github.actor == 'github-actions[bot]' }}
        run: |
          echo "Run triggered by github-actions[bot]. Exiting to avoid loop."
          exit 0

      - name: Checkout repository (with submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: 'recursive'

      - name: Install p7zip (7z)
        run: sudo apt-get update && sudo apt-get install -y p7zip-full

      - name: Locate .7z to extract
        id: find7z
        run: |
          set -euo pipefail
          if [ -n "${{ github.event.inputs.sevenzip_path || '' }}" ]; then
            FILE="${{ github.event.inputs.sevenzip_path }}"
            if [ ! -f "$FILE" ]; then
              echo "ERROR: specified file '$FILE' not found in repo."
              exit 2
            fi
            echo "found=$FILE" >> $GITHUB_OUTPUT
          else
            FILE=$(find . -type f -name '*.7z' -not -path './.git/*' -print -quit || true)
            if [ -z "$FILE" ]; then
              echo "found=" >> $GITHUB_OUTPUT
            else
              # strip leading ./ for neatness
              FILE=${FILE#./}
              echo "found=$FILE" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Extract .7z into repo root (if found)
        if: steps.find7z.outputs.found != ''
        run: |
          set -euo pipefail
          FILE="${{ steps.find7z.outputs.found }}"
          echo "Extracting: $FILE"
          # extract into repo root
          7z x "$FILE" -o. -y

          # Optionally remove archive
          if [ "${{ github.event.inputs.remove_archive }}" = "true" ]; then
            echo "Removing archive $FILE"
            rm -f "$FILE"
          fi

      - name: Flatten ModTemplate directories (move contents to repo root and delete folder)
        run: |
          set -euo pipefail
          SHOPT_SUPPORTED=1
          # ensure we can use dotglob for hidden files
          if ! shopt -s dotglob 2>/dev/null; then
            SHOPT_SUPPORTED=0
          fi

          # Process all ModTemplate directories (except inside .git)
          found_any=0
          while IFS= read -r -d '' moddir; do
            found_any=1
            echo "Processing ModTemplate at: $moddir"

            # don't move if moddir is root (safety)
            if [ "$moddir" = "." ] || [ "$moddir" = "./" ]; then
              echo "Skipping repo root."
              continue
            fi

            # move non-dot and dot files
            if [ "${{ github.event.inputs.avoid_overwrite }}" = "true" ]; then
              mv -n "$moddir"/* . 2>/dev/null || true
              mv -n "$moddir"/.[!.]* . 2>/dev/null || true
            else
              mv "$moddir"/* . 2>/dev/null || true
              mv "$moddir"/.[!.]* . 2>/dev/null || true
            fi

            # remove the now-empty folder
            rm -rf "$moddir"
            echo "Moved contents from $moddir to repo root and removed the directory."
          done < <(find . -type d -name 'ModTemplate' -not -path './.git/*' -print0)

          if [ "$found_any" -eq 0 ]; then
            echo "No ModTemplate directory found; nothing to flatten."
          fi

      - name: Ensure extern/Dobby exists (or clone from input DOBBY_REPO_URL)
        id: dobby_check
        run: |
          set -euo pipefail
          # search possible expected locations
          LOC=$(find app src -type d -path '*/extern/Dobby' -print -quit || true)
          if [ -n "$LOC" ]; then
            echo "found=present" >> $GITHUB_OUTPUT
            echo "path=$LOC" >> $GITHUB_OUTPUT
            echo "Dobby is already present at $LOC"
            exit 0
          fi

          # try fallback path
          if [ -d "extern/Dobby" ]; then
            echo "found=present" >> $GITHUB_OUTPUT
            echo "path=extern/Dobby" >> $GITHUB_OUTPUT
            exit 0
          fi

          # If user supplied DOBBY_REPO_URL, clone it into app/src/main/cpp/extern/Dobby if that path exists or into extern/Dobby
          URL="${{ github.event.inputs.dobby_repo_url || '' }}"
          if [ -n "$URL" ]; then
            TARGET="app/src/main/cpp/extern/Dobby"
            mkdir -p "$(dirname "$TARGET")"
            echo "Cloning Dobby from $URL into $TARGET"
            git clone --depth 1 "$URL" "$TARGET"
            echo "found=cloned" >> $GITHUB_OUTPUT
            echo "path=$TARGET" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "found=missing" >> $GITHUB_OUTPUT
          echo "Dobby not found and no dobby_repo_url provided. Build may fail." >> /dev/stderr

      - name: Commit extracted/moved files (if any)
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add -A
          # commit only if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "CI: extract .7z and flatten ModTemplate (auto-commit) [ci skip]" || true
            # push back to same branch
            git push origin HEAD:${{ github.ref_name || github.head_ref || 'main' }}
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: gradle

      - name: Ensure Android SDK command-line tools (if missing) and install common packages
        run: |
          set -euo pipefail
          export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
          # if sdkmanager not available, install cmdline-tools (some runners already have it)
          if [ ! -x "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
            echo "Installing Android cmdline-tools..."
            cd /tmp
            curl -fSLo commandlinetools.zip "https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip"
            unzip -q commandlinetools.zip
            rm -f commandlinetools.zip
            mkdir -p $ANDROID_SDK_ROOT/cmdline-tools/latest
            mv cmdline-tools/* $ANDROID_SDK_ROOT/cmdline-tools/latest/
          fi

          export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH

          # accept licenses (some packages auto-install during gradle, but pre-install to be safe)
          yes | sdkmanager --sdk_root=${ANDROID_SDK_ROOT} "platform-tools" "platforms;android-33" "build-tools;33.0.2" "ndk;26.1.10909125" "cmake;3.22.1" || true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Show quick debug tree (optional)
        run: |
          echo "=== top-level ==="
          ls -la
          echo "=== app/src/main/cpp ==="
          ls -la app/src/main/cpp || true
          echo "=== extern directories ==="
          find . -type d -name extern -print -exec ls -la {} \; || true

      - name: Build with Gradle
        run: ./gradlew build --stacktrace
